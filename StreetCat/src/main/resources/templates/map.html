<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>네이버 지도 시작하기</title>
<script th:src="@{|https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${naverMapClientId}&submodules=geocoder|}"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
	<div th:replace="header :: header"></div>
	<br>
	<br>

	<!-- 검색창 -->
	<div class="search">
	<input id="address" type="text" placeholder="검색할 주소">
	<input id="submit" type="button" value="주소검색">
	
    <div id="map" style="width:100%;height:500px;"></div>

    <script>
        //현재 위치 설정
        // Geolocation API를 사용하여 현재 위치를 가져옵니다.
	    navigator.geolocation.getCurrentPosition(function(position) {
	        const lat = position.coords.latitude;
	        const lng = position.coords.longitude;
	        
	        var map = new naver.maps.Map('map', {
	            center: new naver.maps.LatLng(lat, lng), //지도의 초기 중심 좌표
	            zoom: 17, //지도의 초기 줌 레벨
	            minZoom: 7, //지도의 최소 줌 레벨
	            zoomControl: true, //줌 컨트롤의 표시 여부
	            zoomControlOptions: { //줌 컨트롤의 옵션
	                position: naver.maps.Position.TOP_RIGHT
	            }
	        
	        });
	        
	     	// 팝업(정보창) 생성
	        var infoWindow = new naver.maps.InfoWindow({
	            anchorSkew: true
	        });
	        
	        //setOptions 메서드를 이용해 옵션을 조정할 수도 있습니다.
		    map.setOptions("mapTypeControl", true); //지도 유형 컨트롤의 표시 여부
		
		    naver.maps.Event.addListener(map, 'zoom_changed', function (zoom) {
		        console.log('zoom:' + zoom);
		    });
		
		    map.setOptions('minZoom', 10);
		    console.log('잘못된 참조 시점', map.getOptions('minZoom'), map.getOptions('minZoom') === 10);
		
		    // 지도의 옵션 참조는 init 이벤트 이후에 참조해야 합니다.
		    naver.maps.Event.once(map, 'init', function () {
		        console.log('올바른 참조 시점', map.getOptions('minZoom') === 10);
		    });
		
		    // 지도 인터랙션 옵션
		    $("#interaction").on("click", function(e) {
		        e.preventDefault();
		
		        if (map.getOptions("draggable")) {
		            map.setOptions({ //지도 인터랙션 끄기
		                draggable: false,
		                pinchZoom: false,
		                scrollWheel: false,
		                keyboardShortcuts: false,
		                disableDoubleTapZoom: true,
		                disableDoubleClickZoom: true,
		                disableTwoFingerTapZoom: true
		            });
		
		            $(this).removeClass("control-on");
		        } else {
		            map.setOptions({ //지도 인터랙션 켜기
		                draggable: true,
		                pinchZoom: true,
		                scrollWheel: true,
		                keyboardShortcuts: true,
		                disableDoubleTapZoom: false,
		                disableDoubleClickZoom: false,
		                disableTwoFingerTapZoom: false
		            });
		
		            $(this).addClass("control-on");
		        }
		    });
		
		    // 타일 fadeIn 효과
		    $("#tile-transition").on("click", function(e) {
		        e.preventDefault();
		
		        if (map.getOptions("tileTransition")) {
		            map.setOptions("tileTransition", false); //타일 fadeIn 효과 끄기
		
		            $(this).removeClass("control-on");
		        } else {
		            map.setOptions("tileTransition", true); //타일 fadeIn 효과 켜기
		            $(this).addClass("control-on");
		        }
		    });
		
		    // min/max 줌 레벨
		    $("#min-max-zoom").on("click", function(e) {
		        e.preventDefault();
		
		        if (map.getOptions("minZoom") === 10) {
		            map.setOptions({
		                minZoom: 7,
		                maxZoom: 21
		            });
		            $(this).val(this.name + ': 7 ~ 21');
		        } else {
		            map.setOptions({
		                minZoom: 10,
		                maxZoom: 21
		            });
		            $(this).val(this.name + ': 10 ~ 21');
		        }
		    });
		
		    //지도 컨트롤
		    $("#controls").on("click", function(e) {
		        e.preventDefault();
		
		        if (map.getOptions("scaleControl")) {
		            map.setOptions({ //모든 지도 컨트롤 숨기기
		                scaleControl: false,
		                logoControl: false,
		                mapDataControl: false,
		                zoomControl: false,
		                mapTypeControl: false
		            });
		            $(this).removeClass('control-on');
		        } else {
		            map.setOptions({ //모든 지도 컨트롤 보이기
		                scaleControl: true,
		                logoControl: true,
		                mapDataControl: true,
		                zoomControl: true,
		                mapTypeControl: true
		            });
		            $(this).addClass('control-on');
		        }
		    });
		
		    $("#interaction, #tile-transition, #controls").addClass("control-on");
	        
	     	// 현재 위치에 마커를 표시할 수도 있습니다.
	        var marker = new naver.maps.Marker({
	            position: new naver.maps.LatLng(lat, lng),
	            map: map
	        });
	        
	        /* TODO const p = marker.position; 현재위치*/
	        
	      	// 새로운 마커 생성
			naver.maps.Event.addListener(map, 'click', function(e) {
				marker.setPosition(e.coord);
				console.log(e.coord);//위치 정보 뜸
				p = e.coord;
			});
	        
	        
	        
	        
	        
	        
	        
	        
			// 주소 검색의 이벤트
			$('#address').on('keydown', function(e) {
			    var keyCode = e.which;
			    if (keyCode === 13) { // Enter Key
			        searchAddressToCoordinate($('#address').val());
			    }
			});
			$('#submit').on('click', function(e) {
			    e.preventDefault();
			    searchAddressToCoordinate($('#address').val());
			});

	        
			//검색한 주소의 정보를 insertAddress 함수로 넘겨준다.
			function searchAddressToCoordinate(address) {
			    naver.maps.Service.geocode({
			        query: address
			    }, function(status, response) {
			    	console.log(status);
			    	console.log(response);

			        if (status === naver.maps.Service.Status.ERROR) {
			            return alert('Something Wrong!');
			        }
			        if (response.v2.meta.totalCount === 0) {
			            return alert('올바른 주소를 입력해주세요.');
			        }
			        var htmlAddresses = [],
			            item = response.v2.addresses[0],
			            point = new naver.maps.Point(item.x, item.y);
			        if (item.roadAddress) {
			            htmlAddresses.push('[도로명 주소] ' + item.roadAddress);
			        }
			        if (item.jibunAddress) {
			            htmlAddresses.push('[지번 주소] ' + item.jibunAddress);
			        }
			        if (item.englishAddress) {
			            htmlAddresses.push('[영문명 주소] ' + item.englishAddress);
			        }

			        // 지도 중심 이동
			        map.setCenter(point);

			        // 팝업 띄우기
			        infoWindow.setContent([
			            '<div style="padding:10px;min-width:200px;line-height:150%;">',
			            '<h4 style="margin-top:5px;">검색 주소 : '+ address +'</h4><br />',
			            htmlAddresses.join('<br />'),
			            '</div>'
			        ].join('\n'));
			        infoWindow.open(map, point);
			       
			        
			    });
			}
			
			
	    });
        
      	
    </script>
</body>
</html>
